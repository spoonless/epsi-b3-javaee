
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="fr">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Web listeners et filtres &#8212; documentation Java EE 1.0</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  false,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/translations.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Recherche" href="search.html" />
    <link rel="prev" title="RequestDispatcher et MVC" href="request_dispatcher.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="web-listeners-et-filtres">
<h1>Web listeners et filtres<a class="headerlink" href="#web-listeners-et-filtres" title="Lien permanent vers ce titre">¶</a></h1>
<p>Les servlets ne sont pas les seuls composants gérés par le conteneur
Web, ce dernier a également la responsabilité de gérer le cycle de vie
des <strong>listeners</strong> et des <strong>filtres</strong> Web.</p>
<div class="section" id="les-listeners-web">
<h2>Les listeners Web<a class="headerlink" href="#les-listeners-web" title="Lien permanent vers ce titre">¶</a></h2>
<p>Un listener (écouteur) est un terme couramment utilisé en Java pour
désigner un objet qui sera notifié lors d’une modification de son
environnement. Dans les patrons de conception (Design Patterns) Objet,
on l’appelle plus généralement <a class="reference external" href="https://fr.wikipedia.org/wiki/Observateur_%28patron_de_conception%29">Observateur</a>.</p>
<p>Pour le conteneur Web Java EE, un listener designe une classe qui
implémente une des interfaces définies dans l’API servlet.</p>
<p>Le principe d’utilisation est le même pour tous les types de listeners
Web. Si l’application souhaite être avertie d’un événement particulier
survenant pour un <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">ServletContext</a> (c’est-à-dire pour l’ensemble de
l’application Web), une requête ou une session HTTP alors elle doit
fournir une implémentation d’un listener. Une méthode de ce dernier sera
appelée par le conteneur à chaque fois que l’événement concerné
surviendra lors de la vie de l’application.</p>
<p>Les différents types de listeners sont représentés dans l’API Servlet
par les <strong>interfaces</strong> Java suivantes&nbsp;:</p>
<dl class="docutils">
<dt><a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html">javax.servlet.ServletContextListener</a></dt>
<dd>Permet d’écouter les changements d’état du <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">ServletContext</a>. Le
conteneur Web avertit l’application de la création du
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">ServletContext</a> grâce à la méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html#contextInitialized-javax.servlet.ServletContextEvent-">contextInitialized</a>
et de la destruction du <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">ServletContext</a> grâce à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html#contextDestroyed-javax.servlet.ServletContextEvent-">contextDestroyed</a>.
Il est important de comprendre que le <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">ServletContext</a> représente
l’application Web. Donc un <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html">ServletContextListener</a> est un moyen
de réaliser des traitements au moment du lancement de l’application
Web et/ou au moment de son arrêt.</dd>
<dt><a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextAttributeListener.html">javax.servlet.ServletContextAttributeListener</a></dt>
<dd>Permet d’écouter les changements d’état des attributs stockés dans
le <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContext.html">ServletContext</a> (les attributs de portée application). Le
conteneur avertit l’application de l’ajout d’un attribut (appel à la
méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextAttributeListener.html#attributeAdded-javax.servlet.ServletContextAttributeEvent-">ServletContextAttributeListener.attributeAdded</a>,
de la suppression d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextAttributeListener.html#attributeRemoved-javax.servlet.ServletContextAttributeEvent-">ServletContextAttributeListener.attributeRemoved</a>
et de la modification d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextAttributeListener.html#attributeReplaced-javax.servlet.ServletContextAttributeEvent-">ServletContextAttributeListener.attributeReplaced</a>.</dd>
<dt><a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestListener.html">javax.servlet.ServletRequestListener</a></dt>
<dd>Permet d’écouter l’entrée et/ou la sortie d’une requête de
l’environnement de l’application Web. Le conteneur avertit
l’application de l’entrée d’une requête à traiter grâce à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestListener.html#requestInitialized-javax.servlet.ServletRequestEvent-">requestInitialized</a>
et de la sortie de la requête grâce à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestListener.html#requestDestroyed-javax.servlet.ServletRequestEvent-">requestDestroyed</a>.</dd>
<dt><a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestAttributeListener.html">javax.servlet.ServletRequestAttributeListener</a></dt>
<dd>Permet d’écouter les changements d’état des attributs stockés dans
la <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpServletRequest.html">HttpServletRequest</a> (les attributs de portée requête). Le
conteneur avertit l’application de l’ajout d’un attribut (appel à la
méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestAttributeListener.html#attributeAdded-javax.servlet.ServletRequestAttributeEvent-">ServletRequestAttributeListener.attributeAdded</a>,
de la suppression d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestAttributeListener.html#attributeRemoved-javax.servlet.ServletRequestAttributeEvent-">ServletRequestAttributeListener.attributeRemoved</a>
et de la modification d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequestAttributeListener.html#attributeReplaced-javax.servlet.ServletRequestAttributeEvent-">ServletRequestAttributeListener.attributeReplaced</a>.</dd>
<dt><a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionListener.html">javax.servlet.http.HttpSessionListener</a></dt>
<dd>Permet d’écouter la création et la suppression d’une
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSession.html">HttpSession</a>. Le conteneur avertit l’application de la création
d’une session grâce à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionListener.html#sessionCreated-javax.servlet.http.HttpSessionEvent-">sessionCreated</a>
et de la suppression d’une session grâce à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionListener.html#sessionDestroyed-javax.servlet.http.HttpSessionEvent-">sessionDestroyed</a>.
La suppression d’une session signifie que soit elle a été invalidée
par l’application elle-même grâce à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSession.html#invalidate--">HttpSession.invalidate</a>
soit elle est arrivée à expiration et le conteneur a décidé de
l’invalider.</dd>
<dt><a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionAttributeListener.html">javax.servlet.http.HttpSessionAttributeListener</a></dt>
<dd>Permet d’écouter les changements d’état des attributs stockés dans
la <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSession.html">HttpSession</a> (les attributs de portée session). Le conteneur
avertit l’application de l’ajout d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionAttributeListener.html#attributeAdded-javax.servlet.http.HttpSessionBindingEvent-">HttpSessionAttributeListener.attributeAdded</a>,
de la suppression d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionAttributeListener.html#attributeRemoved-javax.servlet.http.HttpSessionBindingEvent-">HttpSessionAttributeListener.attributeRemoved</a>
et de la modification d’un attribut (appel à la méthode
<a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionAttributeListener.html#attributeReplaced-javax.servlet.http.HttpSessionBindingEvent-">HttpSessionAttributeListener.attributeReplaced</a>.</dd>
</dl>
<p>Il existe également deux autres listeners Web&nbsp;: Le <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionActivationListener.html">HttpSessionActivationListener</a>
et le <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/http/HttpSessionBindingListener.html">HttpSessionBindingListener</a>.
Ils ne sont pas décrits ici car ils sont réservés à des usages plus
avancés de l’API Servlet.</p>
</div>
<div class="section" id="declaration-des-listeners-web">
<h2>Déclaration des listeners Web<a class="headerlink" href="#declaration-des-listeners-web" title="Lien permanent vers ce titre">¶</a></h2>
<p>Une classe implémentant une ou plusieurs interfaces la désignant comme
un listener Web doit également être déclarée auprès du conteneur Web.
Pour cela, il suffit d’ajouter l’annotation <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/annotation/WebListener.html">&#64;WebListener</a> à la classe&nbsp;:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">Exemple de ServletRequestListener</span><a class="headerlink" href="#id1" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">fr.epsi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequestEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequestListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.annotation.WebListener</span><span class="o">;</span>

<span class="nd">@WebListener</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyServletRequestListener</span> <span class="kd">implements</span> <span class="n">ServletRequestListener</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestInitialized</span><span class="o">(</span><span class="n">ServletRequestEvent</span> <span class="n">sre</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">requestDestroyed</span><span class="o">(</span><span class="n">ServletRequestEvent</span> <span class="n">sre</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Si l”<strong>on ne souhaite pas utiliser une annotation</strong>, il est également
possible de déclarer un listener dans le fichier de déploiement
<code class="file docutils literal"><span class="pre">web.xml</span></code> grâce à la balise <code class="docutils literal"><span class="pre">listener</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Déclaration d’un listener dans le fichier web.xml</span><a class="headerlink" href="#id2" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;web-app</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;https://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xmlns=</span><span class="s">&quot;https://java.sun.com/xml/ns/javaee&quot;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;https://java.sun.com/xml/ns/javaee</span>
<span class="s">                      https://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
  <span class="na">version=</span><span class="s">&quot;3.0&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;listener&gt;</span>
        <span class="nt">&lt;listener-class&gt;</span>fr.epsi.MyServletRequestListener<span class="nt">&lt;/listener-class&gt;</span>
    <span class="nt">&lt;/listener&gt;</span>

<span class="nt">&lt;/web-app&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exemple-d-utilisation-d-un-listener">
<h2>Exemple d’utilisation d’un listener<a class="headerlink" href="#exemple-d-utilisation-d-un-listener" title="Lien permanent vers ce titre">¶</a></h2>
<p>L’exemple (simple) ci-dessous consiste en un <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletContextListener.html">ServletContextListener</a>
dont le rôle est de réaliser un log applicatif signalant respectivement
le lancement et l’arrêt de l’application Web&nbsp;:</p>
<p>Exemple de <code class="docutils literal"><span class="pre">ServletRequestListener</span></code></p>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">fr.epsi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.ServletContextEvent</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletContextListener</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.annotation.WebListener</span><span class="o">;</span>

<span class="nd">@WebListener</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LoggingListener</span> <span class="kd">implements</span> <span class="n">ServletContextListener</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextInitialized</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sce</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">log</span><span class="o">(</span><span class="s">&quot;## Lancement de l&#39;application ##&quot;</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">contextDestroyed</span><span class="o">(</span><span class="n">ServletContextEvent</span> <span class="n">sce</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">sce</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">log</span><span class="o">(</span><span class="s">&quot;## Arrêt de l&#39;application ##&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="les-filtres-de-servlet">
<h2>Les filtres de Servlet<a class="headerlink" href="#les-filtres-de-servlet" title="Lien permanent vers ce titre">¶</a></h2>
<p>Il est parfois intéressant d’effectuer des opérations avant et/ou après
l’invocation de la servlet. Il s’agit souvent d’opérations communes à un
ensemble de requêtes d’une application Web.</p>
<p>Un filtre de Servlet est une classe implémentant l’interface <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/Filter.html">Filter</a>.
Un filtre a son propre cycle de vie. Une fois créé, le conteneur
initialise le filtre en appelant sa méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/Filter.html#init-javax.servlet.FilterConfig-">Filter.init</a> et il signalera la
destruction du filtre en appelant sa méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/Filter.html#destroy--">Filter.destroy</a>.
L’opération de filtrage est réalisée grâce à la méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/Filter.html#doFilter-javax.servlet.ServletRequest-javax.servlet.ServletResponse-javax.servlet.FilterChain-">Filter.doFilter</a>.</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Exemple d’implémentation d’un filtre Web</span><a class="headerlink" href="#id3" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">fr.epsi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
                                                                   <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="declaration-des-filtres">
<h2>Déclaration des filtres<a class="headerlink" href="#declaration-des-filtres" title="Lien permanent vers ce titre">¶</a></h2>
<p>La déclaration d’un filtre Web auprès du conteneur se fait soit par
l’annotation <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/annotation/WebFilter.html">&#64;WebFilter</a> soit dans le fichier de déploiement <code class="file docutils literal"><span class="pre">web.xml</span></code>.</p>
<p>Comme pour une Servlet, un filtre est associé à un ou plusieurs motifs
d’URL (URL pattern) indiquant au conteneur pour quelles requêtes HTTP le
filtre doit être appelé.</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Déclaration d’un filtre Web par annotation</span><a class="headerlink" href="#id4" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">fr.epsi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.annotation.WebFilter</span><span class="o">;</span>

<span class="nd">@WebFilter</span><span class="o">({</span><span class="s">&quot;/subpart/*&quot;</span><span class="o">,</span> <span class="s">&quot;/otherpart/*&quot;</span><span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
                                                            <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// ...</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<p>Si <strong>on ne souhaite pas utiliser une annotation</strong>, il est également
possible de déclarer un listener dans le fichier de déploiement web.xml
grâce aux balises <code class="docutils literal"><span class="pre">filter</span></code> et <code class="docutils literal"><span class="pre">filter-mapping</span></code>.</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Déclaration d’un filtre dans le fichier web.xml</span><a class="headerlink" href="#id5" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="nt">&lt;web-app</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;https://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xmlns=</span><span class="s">&quot;https://java.sun.com/xml/ns/javaee&quot;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;https://java.sun.com/xml/ns/javaee</span>
<span class="s">                      https://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
  <span class="na">version=</span><span class="s">&quot;3.0&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;filter&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>MyFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;filter-class&gt;</span>fr.epsi.MyFilter<span class="nt">&lt;/filter-class&gt;</span>
  <span class="nt">&lt;/filter&gt;</span>

  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>MyFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/subpart/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>

  <span class="nt">&lt;filter-mapping&gt;</span>
    <span class="nt">&lt;filter-name&gt;</span>MyFilter<span class="nt">&lt;/filter-name&gt;</span>
    <span class="nt">&lt;url-pattern&gt;</span>/otherpart/*<span class="nt">&lt;/url-pattern&gt;</span>
  <span class="nt">&lt;/filter-mapping&gt;</span>
<span class="nt">&lt;/web-app&gt;</span>
</pre></div>
</div>
</div>
<p>Il est également possible de déclarer qu’un filtre doit être utilisé
pour des requêtes traitées par des Servlets spécifiques plutôt que
d’utiliser un modèle d’URL.</p>
</div>
<div class="section" id="implementation-d-un-filtre">
<h2>Implémentation d’un filtre<a class="headerlink" href="#implementation-d-un-filtre" title="Lien permanent vers ce titre">¶</a></h2>
<p>L’opération de filtrage est réalisée par la méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/Filter.html#doFilter-javax.servlet.ServletRequest-javax.servlet.ServletResponse-javax.servlet.FilterChain-">Filter.doFilter</a>.</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Principe général d’implémentation d’un filtre</span><a class="headerlink" href="#id6" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-xml"><div class="highlight"><pre><span></span>@Override
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
                                                       throws IOException, ServletException {
    // réaliser des opérations avant le traitement de la requête

    // appeler l&#39;élément suivant dans la chaîne de filtrage
    chain.doFilter(request, response);

    // réaliser des opérations après le traitement de la requête
}
</pre></div>
</div>
</div>
<p>Si plusieurs filtres doivent être déclenchés pour le traitement d’une
requête, alors l’appel à <code class="docutils literal"><span class="pre">chain.doFilter(...)</span></code> permet de passer au
filtre suivant. Un fois le dernier filtre appelé, l’appel à
<code class="docutils literal"><span class="pre">chain.doFilter(...)</span></code> passera au traitement normal de la requête
(Servlet, JSP ou ressource statique).</p>
<p>Il est recommandé d’implémenter des filtres de manière à ce qu’ils
soient indépendants les uns des autres. En effet, si plusieurs filtres
sont appelés pour le traitement d’une requête, l’ordre dans lequel ces
filtres seront appelés n’est pas prédictible s’ils ont été déclarés avec
l’annotation <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/annotation/WebFilter.html">&#64;WebFilter</a>. En revanche, ils seront appelés dans
l’ordre des balises <code class="docutils literal"><span class="pre">filter-mapping</span></code> s’ils ont été déclarés à partir
du fichier de déploiement <code class="file docutils literal"><span class="pre">web.xml</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Une implémentation de filtre peut très bien ne pas appeler
<code class="docutils literal"><span class="pre">chain.doFilter(...)</span></code> et choisir de générer directement une réponse.</p>
</div>
</div>
<div class="section" id="cas-d-utilisation-de-filtres">
<h2>Cas d’utilisation de filtres<a class="headerlink" href="#cas-d-utilisation-de-filtres" title="Lien permanent vers ce titre">¶</a></h2>
<p>Deux exemples d’implémentation de filtres simples mais efficaces.</p>
<div class="section" id="gestion-de-l-utf-8">
<h3>Gestion de l’UTF-8<a class="headerlink" href="#gestion-de-l-utf-8" title="Lien permanent vers ce titre">¶</a></h3>
<p>Un cas facilement compréhensible est celui d’une application Web qui
poste les données de tous ses formulaires HTML en UTF-8. Nous avons vu
que par défaut, le conteneur Web utilise l’encodage ISO-8859-1
(Latin-1). Il est donc nécessaire de positionner le bon encodage grâce à
la méthode <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/ServletRequest.html#setCharacterEncoding-java.lang.String-">ServletRequest.setCharacterEncoding(String)</a>.
Cette opération répétitive est source d’oubli (et donc de bug). Il
serait préférable de garantir que cette méthode soit systématiquement
appelée avant chaque traitement de Servlet. Ce type de comportement peut
très facilement être implémenté au moyen d’un filtre Web.</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Filtre UTF-8</span><a class="headerlink" href="#id7" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">fr.epsi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.annotation.WebFilter</span><span class="o">;</span>

<span class="nd">@WebFilter</span><span class="o">(</span><span class="s">&quot;/*&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Utf8RequestEncodingFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
                                                                <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="n">request</span><span class="o">.</span><span class="na">setCharacterEncoding</span><span class="o">(</span><span class="s">&quot;UTF-8&quot;</span><span class="o">);</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="generation-de-log">
<h3>Génération de log<a class="headerlink" href="#generation-de-log" title="Lien permanent vers ce titre">¶</a></h3>
<p>Il peut être intéressant de garder une trace des paramètres HTTP reçus
lors des tests ou pour des statistiques. Le filtre ci-dessous écrit dans
les logs du serveur le nom et la valeur de tous les paramètres reçus&nbsp;:</p>
<div class="literal-block-wrapper docutils container" id="id8">
<div class="code-block-caption"><span class="caption-text">Filtre de log de paramètres</span><a class="headerlink" href="#id8" title="Lien permanent vers ce code">¶</a></div>
<div class="highlight-java"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">fr.epsi</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.servlet.Filter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterChain</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.FilterConfig</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletRequest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.ServletResponse</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.servlet.annotation.WebFilter</span><span class="o">;</span>

<span class="nd">@WebFilter</span><span class="o">(</span><span class="s">&quot;/*&quot;</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">LogFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span> <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span>
                                                                    <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getServletContext</span><span class="o">().</span><span class="na">log</span><span class="o">(</span><span class="s">&quot;parameters received: &quot;</span> <span class="o">+</span> <span class="n">parametersToString</span><span class="o">(</span><span class="n">request</span><span class="o">));</span>
        <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">parametersToString</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">parameters</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
        <span class="n">request</span><span class="o">.</span><span class="na">getParameterMap</span><span class="o">().</span><span class="na">forEach</span><span class="o">((</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">parameters</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">k</span> <span class="o">+</span> <span class="s">&quot;=&quot;</span> <span class="o">+</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">v</span><span class="o">)));</span>
        <span class="k">return</span> <span class="n">parameters</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="n">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="admonition caution">
<p class="first admonition-title">Prudence</p>
<p class="last">L’utilisation conjointe des deux filtres ci-dessus peut poser problème.
En effet, la méthode <code class="docutils literal"><span class="pre">request.setCharacterEncoding(...)</span></code> dans la
classe <code class="docutils literal"><span class="pre">Utf8RequestEncodingFilter</span></code> doit être appelée avant que les
paramètres de la requête ne soient accédés. Le filtre
<code class="docutils literal"><span class="pre">Utf8RequestEncodingFilter</span></code> doit donc être placé <strong>avant</strong> le filtre
<code class="docutils literal"><span class="pre">LogFilter</span></code>. Malheureusement, cela ne peut pas être garanti par
l’utilisation de l’annotation <a class="reference external" href="https://docs.oracle.com/javaee/7/api/javax/servlet/annotation/WebFilter.html">&#64;WebFilter</a>.</p>
</div>
<p>On peut imaginer des traitements bien plus complexes grâce aux filtres&nbsp;:
contrôle des droits d’accès (autorisation), optimisation d’image,
chiffrement des données…</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Java EE</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="environnement_developpement.html">L’environnement de développement</a></li>
<li class="toctree-l1"><a class="reference internal" href="premiere_application.html">Une première application</a></li>
<li class="toctree-l1"><a class="reference internal" href="maven.html">Introduction à Maven</a></li>
<li class="toctree-l1"><a class="reference internal" href="servlet.html">Les Servlets</a></li>
<li class="toctree-l1"><a class="reference internal" href="conteneur_web.html">Le conteneur Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="attributs_web.html">Les attributs d’une application Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="jsp.html">JSP : Java Server Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_dispatcher.html">RequestDispatcher et MVC</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Web listeners et filtres</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#les-listeners-web">Les listeners Web</a></li>
<li class="toctree-l2"><a class="reference internal" href="#declaration-des-listeners-web">Déclaration des listeners Web</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exemple-d-utilisation-d-un-listener">Exemple d’utilisation d’un listener</a></li>
<li class="toctree-l2"><a class="reference internal" href="#les-filtres-de-servlet">Les filtres de Servlet</a></li>
<li class="toctree-l2"><a class="reference internal" href="#declaration-des-filtres">Déclaration des filtres</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation-d-un-filtre">Implémentation d’un filtre</a></li>
<li class="toctree-l2"><a class="reference internal" href="#cas-d-utilisation-de-filtres">Cas d’utilisation de filtres</a></li>
</ul>
</li>
</ul>


<hr />
<ul>
    
    <li class="toctree-l1"><a href="http://docs.oracle.com/javase/8/docs/api/index.html?overview-summary.html">API Java</a></li>
    
    <li class="toctree-l1"><a href="https://docs.oracle.com/javaee/7/api/">API Java EE</a></li>
    
    <li class="toctree-l1"><a href="http://docs.oracle.com/javase/8/docs/">Documentation Java</a></li>
    
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Recherche rapide</h3>
    <form class="search" action="search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;
<a ref="author" href="mailto:dagaydevel@free.fr">David Gayerie</a>
<a rel="license" href="https://creativecommons.org/licenses/by-sa/3.0/fr/"><img alt="Licence Creative Commons" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/3.0/fr/80x15.png" /></a>
.
      
    </div>

    

    
  </body>
</html>